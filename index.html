<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mothership 1e Manifest + Tiered Monitor (v2.2-debug)</title> <style>
        /* CSS unchanged from v2.2 */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root{--monitor-bg: black;--primary-color: lime;--warning-color: #FFD700;--injured-ekg-color: #FFD700;--critical-color: #FF851B;--incapacitated-color: #FF4136;--dead-color: #555555;--card-bg: #1a1a1a;--card-border-color: var(--primary-color);--text-color: var(--primary-color);--overlay-text-color: white;--input-bg: #222;--input-border: var(--primary-color);--grid-color: rgba(0, 255, 0, 0.08);--font-family: 'VT323', monospace;--text-shadow: 1px 1px 2px black;--card-shadow: 3px 3px 8px rgba(0, 0, 0, 0.7);--disabled-color: #777;--disabled-input-bg: #333;--button-text-color: var(--text-color);--button-hover-bg: var(--primary-color);--button-hover-text: black;--button-hover-border: var(--primary-color);--dark-bg-color: #05101f;--dark-card-bg: #0a182f;--dark-primary-color: #7FDBFF;--dark-text-color: var(--dark-primary-color);--dark-overlay-text-color: #f0f8ff;--dark-card-border-color: var(--dark-primary-color);--dark-input-bg: #1a284f;--dark-input-border: var(--dark-primary-color);--dark-grid-color: rgba(127, 219, 255, 0.08);--dark-warning-color: #FFDC00;--dark-injured-ekg-color: #FFDC00;--dark-critical-color: #FF851B;--dark-incapacitated-color: #FF4136;--dark-dead-color: #666;--dark-disabled-color: #555;--dark-disabled-input-bg: #222;--dark-button-hover-bg: var(--dark-primary-color);--dark-button-hover-text: #05101f;--dark-button-hover-border: var(--dark-primary-color);}
        body{font-family:var(--font-family);background-color:var(--card-bg);color:var(--text-color);margin:0;padding:0;font-size:18px;transition:background-color .3s ease,color .3s ease}.main-controls{text-align:center;margin:20px 0}.main-controls button{background-color:var(--input-bg);color:var(--button-text-color);border:2px solid var(--input-border);font-family:inherit;font-size:1.1em;padding:8px 15px;border-radius:4px;cursor:pointer;text-transform:uppercase;margin:0 10px;transition:background-color .2s,color .2s,border-color .2s}.main-controls button:hover:not(:disabled){background-color:var(--button-hover-bg);color:var(--button-hover-text);border-color:var(--button-hover-border)}.main-controls button:active:not(:disabled){transform:translateY(1px)}#clear-data-button{border-color:var(--warning-color);color:var(--warning-color)}#clear-data-button:hover:not(:disabled){background-color:var(--warning-color);color:#000;border-color:var(--warning-color)}
        h1{color:var(--primary-color);text-align:center;letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;text-shadow:1px 1px 0 rgba(0,0,0,.5)}.dashboard-container{padding:0 20px 20px;max-width:1800px;margin:0 auto}.dashboard{display:flex;flex-wrap:wrap;gap:25px;justify-content:center}.character-card{border:3px solid var(--card-border-color);background-color:var(--card-bg);padding:10px;border-radius:4px;width:320px;box-shadow:inset 0 0 8px 0 rgba(0,0,0,.5),3px 3px 8px rgba(0,0,0,.7);display:flex;flex-direction:column;color:var(--text-color);position:relative;transition:border-color .3s ease,opacity .3s ease}.remove-button{position:absolute;top:3px;right:3px;background-color:#500;color:#fcc;border:1px solid #a00;border-radius:50%;width:22px;height:22px;font-size:12px;font-weight:700;line-height:20px;text-align:center;cursor:pointer;padding:0;box-shadow:1px 1px 3px rgba(0,0,0,.5);z-index:10}.remove-button:hover{background-color:#a00;color:#fff}
        .health-monitor{background-color:var(--monitor-bg);border:1px solid var(--text-color);border-radius:2px;width:100%;height:160px;overflow:hidden;position:relative;margin-bottom:10px;background-image:linear-gradient(var(--grid-color) 1px,transparent 1px),linear-gradient(90deg,var(--grid-color) 1px,transparent 1px);background-size:12px 12px;cursor:default}.svg-container{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none}.health-monitor svg{display:block;width:100%;height:100%}.health-monitor path{stroke-dasharray:3000}
        .monitor-text-overlay{position:absolute;top:0;left:0;width:100%;height:100%;padding:5px 8px;box-sizing:border-box;display:flex;flex-direction:column;justify-content:space-between;z-index:2;pointer-events:none}.monitor-text-overlay>*{pointer-events:auto}.monitor-text-overlay>div{pointer-events:none}.monitor-text-overlay>div>*{pointer-events:auto}.char-name-display{display:inline-block;background-color:rgba(0,0,0,.6);padding:2px 6px;border-radius:2px;font-size:1.6em;color:var(--overlay-text-color);text-shadow:var(--text-shadow);text-transform:uppercase;cursor:pointer;max-width:calc(100% - 30px);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-weight:400}.char-name-edit{display:none;background-color:var(--input-bg);border:1px solid var(--warning-color);color:var(--overlay-text-color);font-family:inherit;font-size:1.6em;text-transform:uppercase;padding:1px 5px;width:calc(100% - 30px);box-sizing:border-box;outline:0;font-weight:400}.status-display{align-self:flex-end;background-color:rgba(0,0,0,.6);padding:2px 6px;border-radius:2px;font-size:1.1em;font-weight:700;color:var(--overlay-text-color);text-shadow:var(--text-shadow);text-transform:uppercase}
        .card-section{padding:8px 5px;margin-top:8px;border-top:1px solid rgba(var(--primary-color),.3)}.card-section:first-of-type{margin-top:0;border-top:none;padding-top:0}.wounds-controls{display:flex;justify-content:space-around;align-items:center}.wound-adjust{display:flex;align-items:center;gap:8px}.wound-adjust label{font-size:1em;margin-right:5px}.wound-adjust button{width:30px;height:30px;padding:0;font-size:1.3em;line-height:1;cursor:pointer;background-color:var(--input-bg);color:var(--text-color);border:1px solid var(--input-border);border-radius:2px}.wound-inputs{display:flex;gap:10px}.wound-input-group{display:flex;flex-direction:column;align-items:center;font-size:.9em}.wound-input-group label{margin-bottom:2px;text-transform:uppercase}.wound-input-group input{width:45px;text-align:center;padding:2px 4px;background-color:var(--input-bg);color:var(--text-color);border:1px solid var(--input-border);border-radius:2px;font-family:inherit;font-size:1em;-moz-appearance:textfield}.wound-input-group input::-webkit-inner-spin-button,.wound-input-group input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}.info-grid{display:flex;flex-direction:column;gap:10px}.stat-adjust{display:flex;justify-content:space-between;align-items:center}.info-grid label{font-weight:400;margin-right:5px;color:var(--text-color);flex-shrink:0}.value-adjust-wrapper{display:flex;align-items:center;gap:5px}.value-adjust-wrapper button{width:25px;height:25px;padding:0;font-size:1.1em;line-height:1;background-color:var(--input-bg);color:var(--text-color);border:1px solid var(--input-border);border-radius:2px;cursor:pointer}.value-adjust-wrapper button:hover:not(:disabled){background-color:var(--button-hover-bg);color:var(--button-hover-text);border-color:var(--button-hover-border)}.value-adjust-wrapper button:active:not(:disabled){transform:translateY(1px)}.value-adjust-wrapper input[type=number]{width:50px;text-align:right;padding:2px 4px;background-color:var(--input-bg);color:var(--text-color);border:1px solid var(--input-border);border-radius:2px;font-family:inherit;font-size:1em;-moz-appearance:textfield}.value-adjust-wrapper input[type=number]::-webkit-inner-spin-button,.value-adjust-wrapper input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        input:disabled{background-color:var(--disabled-input-bg)!important;opacity:.6;cursor:not-allowed;border-color:var(--disabled-color)!important;color:var(--disabled-color)!important}button:disabled{opacity:.5;cursor:not-allowed!important;background-color:var(--input-bg)!important;color:var(--disabled-color)!important;border-color:var(--disabled-color)!important}.type-select{background-color:var(--input-bg);color:var(--text-color);border:1px solid var(--input-border);border-radius:2px;font-family:inherit;font-size:1em;padding:2px 4px;flex-grow:1;max-width:150px}.type-select:focus{outline:0;border-color:var(--warning-color)}.saves-armor-panel{display:grid;grid-template-columns:repeat(2,1fr);gap:10px 15px}.save-input-group{display:flex;align-items:center;justify-content:space-between}.save-input-group label{font-size:.95em;text-transform:uppercase;margin-right:5px}.save-input-group input{width:50px;text-align:right;padding:2px 4px;background-color:var(--input-bg);color:var(--text-color);border:1px solid var(--input-border);border-radius:2px;font-family:inherit;font-size:1em;-moz-appearance:textfield}.save-input-group input::-webkit-inner-spin-button,.save-input-group input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}.action-button-area{padding:10px 0 0;text-align:center}.action-button-area button{background-color:var(--input-bg);color:var(--text-color);border:1px solid var(--input-border);font-family:inherit;font-size:1em;padding:6px 12px;border-radius:2px;cursor:pointer;text-transform:uppercase;width:auto}.action-button-area button:hover:not(:disabled){background-color:var(--button-hover-bg);color:var(--button-hover-text);border-color:var(--button-hover-border)}.action-button-area button:active:not(:disabled){transform:translateY(1px)}.mark-dead-btn{border-color:var(--dead-color);color:var(--dead-color)}.mark-dead-btn:hover:not(:disabled){background-color:var(--dead-color);color:#fff;border-color:var(--dead-color)}
        .character-card.status-injured{border-color:var(--warning-color)}.character-card.status-critical{border-color:var(--critical-color)}.character-card.status-incapacitated{border-color:var(--incapacitated-color)}.character-card.status-dead{border-color:var(--dead-color);box-shadow:inset 0 0 8px 0 rgba(100,100,100,.5),3px 3px 8px rgba(0,0,0,.7);opacity:.7}.character-card.status-dead>*:not(.remove-button){filter:grayscale(90%)}.character-card.status-dead .monitor-text-overlay *,.character-card.status-dead .wounds-controls *,.character-card.status-dead .info-grid *,.character-card.status-dead .saves-armor-panel *,.character-card.status-dead .action-button-area button{color:var(--dead-color)!important;border-color:var(--dead-color)!important;text-shadow:1px 1px 2px #000}.character-card.status-incapacitated .health-monitor{filter:none}
        .character-card.status-dead input,.character-card.status-dead button,.character-card.status-dead select{pointer-events:none!important}.character-card.status-incapacitated input,.character-card.status-incapacitated button,.character-card.status-incapacitated select{pointer-events:auto!important}
        .character-card.status-dead .remove-button,.character-card.status-dead .char-name-display,.character-card.status-dead .char-name-edit,.character-card.status-dead .input-wounds-max,.character-card.status-dead .input-ap,.character-card.status-dead .type-select,.character-card.status-dead .input-save-body,.character-card.status-dead .input-save-fear,.character-card.status-dead .input-save-sanity{pointer-events:auto!important;filter:none!important;opacity:1!important}.character-card.status-dead .char-name-display{cursor:pointer}
        body.dark-mode{--card-bg:var(--dark-card-bg);--card-border-color:var(--dark-card-border-color);--text-color:var(--dark-text-color);--primary-color:var(--dark-primary-color);--warning-color:var(--dark-warning-color);--injured-ekg-color:var(--dark-injured-ekg-color);--critical-color:var(--dark-critical-color);--incapacitated-color:var(--dark-incapacitated-color);--dead-color:var(--dark-dead-color);--overlay-text-color:var(--dark-overlay-text-color);--input-bg:var(--dark-input-bg);--input-border:var(--dark-input-border);--grid-color:var(--dark-grid-color);--disabled-color:var(--dark-disabled-color);--disabled-input-bg:var(--dark-disabled-input-bg);--button-text-color:var(--dark-text-color);--button-hover-bg:var(--dark-button-hover-bg);--button-hover-text:var(--dark-button-hover-text);--button-hover-border:var(--dark-button-hover-border)}body.dark-mode .char-name-display,body.dark-mode .status-display{background-color:rgba(255,255,255,.1);text-shadow:var(--text-shadow)}body.dark-mode .remove-button{background-color:#3080a0;border-color:var(--dark-primary-color)}body.dark-mode .remove-button:hover{background-color:var(--dark-warning-color);color:#000}body.dark-mode input:disabled{background-color:var(--dark-disabled-input-bg)!important}body.dark-mode button:disabled{color:var(--dark-disabled-color)!important;border-color:var(--dark-disabled-color)!important;background-color:var(--dark-input-bg)!important}body.dark-mode .mark-dead-btn{border-color:var(--dark-dead-color);color:var(--dark-dead-color)}body.dark-mode .mark-dead-btn:hover:not(:disabled){background-color:var(--dark-dead-color);color:#fff;border-color:var(--dark-dead-color)}
    </style>
</head>
<body>

<div class="dashboard-container">
    <h1>MOTHERSHIP 1e :: MANIFEST</h1>
    <div class="main-controls">
        <button onclick="addCombatant()">Add Unit</button>
        <button id="theme-toggle-button" onclick="toggleTheme()">Toggle Theme</button>
        <button id="clear-data-button" onclick="clearSavedData()">Clear Saved Data</button>
    </div>
    <div class="dashboard" id="dashboard"></div>
</div>

<script>
    // --- SVG Data Store ---
    const svgStates = { /* SVG Data unchanged */
        healthy: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="none"/> <path d="M17.9,114.5 h26.9 c2.3,0 12.9,-10.2 20.1,-10.2 c7.2,0 10.8,10.2 12.6,10.2h18.3 l7.2,10.8 l7.5,-100.9 l5.1,115 l6.9,-24.6h24.4 c3.2,0 14.8,-16.8 20.2,-16.8 s11.1,16.5 13.5,16.5 c2.8,0 26.7,0 26.7,0h27.8 c2.3,0 12.9,-10.2 20.1,-10.2 c7.2,0 10.8,10.2 12.6,10.2h18.3 l7.2,10.8 l7.5,-100.9 l5.1,115 l6.9,-24.6h24.4 c3.2,0 14.8,-16.8 20.2,-16.8 s11.1,16.5 13.5,16.5 c2.8,0 26.7,0 26.7,0h27.8 c2.3,0 12.9,-10.2 20.1,-10.2 s10.8,10.2 12.6,10.2h18.3 l7.2,10.8 l7.5,-100.9 l5.1,115 l6.9,-24.6 h24.4 c3.2,0 14.8,-16.8 20.2,-16.8 s11.1,16.5 13.5,16.5 c2.8,0 26.7,0 26.7,0h27.8 c2.3,0 12.9,-10.2 20.1,-10.2 c7.2,0 10.8,10.2 12.6,10.2h18.3 l7.2,10.8 l7.5,-100.9 l5.1,115 l6.9,-24.6h24.4 c3.2,0 14.8,-16.8 20.2,-16.8 s11.1,16.5 13.5,16.5 c2.8,0 26.7,0 26.7,0" fill="none" stroke="var(--primary-color)" stroke-width="2" stroke-dasharray="3000"><animate attributeName="stroke-dashoffset" from="3000" to="0" dur="5s" linear="true" repeatCount="indefinite"/></path></svg>`,
        injured: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="none"/> <path d="M 0,114.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5" fill="none" stroke="var(--injured-ekg-color)" stroke-width="2"><animate attributeName="stroke-dashoffset" from="3000" to="0" dur="4s" linear="true" repeatCount="indefinite"/></path> </svg>`,
        critical: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="none"/> <path d="M 0,114.5 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 c 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 c 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 c 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 c 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 c 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 c 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 c 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 c 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9" fill="none" stroke="var(--critical-color)" stroke-width="2"><animate attributeName="stroke-dashoffset" from="3000" to="0" dur="2.8s" linear="true" repeatCount="indefinite"/></path> </svg>`,
        incapacitated: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="none"/> <path d="M0,100 H800" fill="none" stroke="var(--incapacitated-color)" stroke-width="4"><animate attributeName="stroke-dashoffset" from="800" to="0" dur="1.8s" linear="true" repeatCount="indefinite"/></path> </svg>`,
        // dead: `<svg>...</svg>` // Static version not needed for monitor display
    };
    // --- Character Data Store ---
    let characters = { /* unchanged */
        char1: { name: "RIPLEY", woundsMax: 3, woundsCurrent: 3, stress: 5, saveBody: 45, saveFear: 50, saveSanity: 40, armorPoints: 5, type: 'Marine', status: "Healthy", svgStateKey: 'healthy' },
        npc1: { name: "DAVIS", woundsMax: 2, woundsCurrent: 1, stress: 8, saveBody: 35, saveFear: 40, saveSanity: 55, armorPoints: 0, type: 'Scientist', status: "Critical", svgStateKey: 'critical' },
        android1: { name: "BISHOP", woundsMax: 4, woundsCurrent: 0, stress: null, saveBody: 60, saveFear: null, saveSanity: null, armorPoints: 0, type: 'Android', status: "Incapacitated", svgStateKey: 'incapacitated' },
        xeno1: { name: "DRONE", woundsMax: 5, woundsCurrent: 2, stress: null, saveBody: 70, saveFear: null, saveSanity: null, armorPoints: 10, type: 'Creature', status: "Injured", svgStateKey: 'injured' },
    };
    let nextCombatantIdCounter = 1;
    // --- Global Constants ---
    const LOCAL_STORAGE_KEY = 'mothershipManifestState_v1e_tiered_v2';
    const THEME_STORAGE_KEY = 'mothershipCombatTheme_v1e';
    // --- Functions ---
    // unchanged: generateNewCombatantId, removeCombatant, showNameInput, hideNameInput, setAnimationSpeed
    // unchanged: saveStateToLocalStorage, loadStateFromLocalStorage, calculateNextIdCounter
    // unchanged: applyTheme, toggleTheme
    // unchanged: renderCharacterCard, createCharacterCardElement, renderDashboard
    // unchanged: updateStatus
     function generateNewCombatantId() { console.log("generateNewCombatantId called"); let newId; do { newId = `combatant${nextCombatantIdCounter++}`; } while (characters[newId]); console.log(`Generated ID: ${newId}`); return newId; }
     function addCombatant() { console.log("addCombatant called"); try { const newId = generateNewCombatantId(); characters[newId] = { name: "ROOKIE", woundsMax: 2, woundsCurrent: 2, stress: 0, saveBody: 30, saveFear: 30, saveSanity: 30, armorPoints: 0, type: 'Teamster', status: "Healthy", svgStateKey: 'healthy' }; console.log("New character object created:", characters[newId]); renderDashboard(); saveStateToLocalStorage(); console.log("addCombatant finished"); } catch (error) { console.error("Error in addCombatant:", error); alert("Error adding unit."); } }
     function removeCombatant(charId) { console.log(`removeCombatant called for ${charId}`); try { const c = characters[charId]; if (!c) return; if (confirm(`Permanently remove ${c.name}?`)) { delete characters[charId]; renderDashboard(); saveStateToLocalStorage(); } } catch (error) { console.error("Error in removeCombatant:", error); alert("Error removing unit."); } }
     function showNameInput(charId, inputId, displayId) { console.log(`showNameInput called for ${charId}`); try { const i = document.getElementById(inputId); const d = document.getElementById(displayId); if (!i||!d||!characters[charId]) return; i.value = characters[charId].name || ""; d.style.display = 'none'; i.style.display = 'inline-block'; i.focus(); i.select(); } catch (e) { console.error("Error in showNameInput:", e);}}
     function hideNameInput(charId, inputId, displayId, save) { console.log(`hideNameInput called for ${charId}`); try { const i = document.getElementById(inputId); const d = document.getElementById(displayId); if (!i||!d||!characters[charId]) return; i.style.display = 'none'; d.style.display = 'inline-block'; if (save && i.value.trim() !== characters[charId].name ) { updateStatus(charId, 'setName', i.value); } else { d.textContent = (characters[charId].name || "NO NAME").toUpperCase(); } } catch (e) { console.error("Error in hideNameInput:", e);}}
     function setAnimationSpeed(monitorElement, charData) { try { const anim = monitorElement.querySelector('svg path animate'); if (anim) { let dur = '5s'; if (charData.svgStateKey === 'injured') { dur = '4s'; } else if (charData.svgStateKey === 'critical') { dur = '2.8s'; } else if (charData.svgStateKey === 'incapacitated') { dur = '1.8s'; } if (anim.getAttribute('dur') !== dur) { anim.setAttribute('dur', dur); } } } catch(e) { console.error("Error setting animation speed:", e); }}
     function saveStateToLocalStorage() { try { const stateToSave = { charactersData: characters, nextId: nextCombatantIdCounter }; const stateString = JSON.stringify(stateToSave); localStorage.setItem(LOCAL_STORAGE_KEY, stateString); } catch (error) { console.error("Error saving state:", error); } }
     function loadStateFromLocalStorage() { console.log("loadStateFromLocalStorage called"); const savedStateString = localStorage.getItem(LOCAL_STORAGE_KEY); if (!savedStateString) { console.log("No saved tiered state found."); return false; } try { const loadedState = JSON.parse(savedStateString); if (typeof loadedState === 'object' && loadedState !== null && loadedState.charactersData) { characters = loadedState.charactersData; Object.values(characters).forEach(char => { if (!char) return; char.woundsMax = char.woundsMax ?? 2; char.woundsCurrent = char.woundsCurrent ?? char.woundsMax; char.armorPoints = char.armorPoints ?? 0; char.saveBody = char.saveBody ?? 30; char.saveFear = char.type === 'Android' ? null : (char.saveFear ?? 30); char.saveSanity = char.type === 'Android' ? null : (char.saveSanity ?? 30); char.stress = (char.type === 'Android' || char.type === 'Creature') ? null : (char.stress ?? 0); char.name = char.name ?? "UNKNOWN"; char.type = char.type ?? "NPC"; if (char.status !== "Dead") { const currentW = char.woundsCurrent ?? 0; const maxW = char.woundsMax ?? 1; if (currentW <= 0) { char.status = "Incapacitated"; char.svgStateKey = "incapacitated"; } else if (currentW === 1 && maxW > 1) { char.status = "Critical"; char.svgStateKey = "critical"; } else if (currentW < maxW) { char.status = "Injured"; char.svgStateKey = "injured"; } else { char.status = "Healthy"; char.svgStateKey = "healthy"; } } else { char.woundsCurrent = 0; char.svgStateKey = "incapacitated"; } delete char.hpMax; delete char.hpCurrent; delete char.initiative; delete char.radiation; delete char.conditions; delete char.saveArmor; }); nextCombatantIdCounter = loadedState.nextId || calculateNextIdCounter(characters); console.log("Tiered State v2 loaded successfully."); return true; } else { throw new Error("Invalid tiered data format."); } } catch (error) { console.error("Error parsing loaded tiered state:", error); alert(`Could not load saved tiered state.\nError: ${error.message}\n\nClearing data.`); localStorage.removeItem(LOCAL_STORAGE_KEY); characters = { char1: { name: "RIPLEY", woundsMax: 3, woundsCurrent: 3, stress: 5, saveBody: 45, saveFear: 50, saveSanity: 40, armorPoints: 5, type: 'Marine', status: "Healthy", svgStateKey: 'healthy' }, npc1: { name: "DAVIS", woundsMax: 2, woundsCurrent: 1, stress: 8, saveBody: 35, saveFear: 40, saveSanity: 55, armorPoints: 0, type: 'Scientist', status: "Critical", svgStateKey: 'critical' }, android1: { name: "BISHOP", woundsMax: 4, woundsCurrent: 0, stress: null, saveBody: 60, saveFear: null, saveSanity: null, armorPoints: 0, type: 'Android', status: "Incapacitated", svgStateKey: 'incapacitated' }, xeno1: { name: "DRONE", woundsMax: 5, woundsCurrent: 2, stress: null, saveBody: 70, saveFear: null, saveSanity: null, armorPoints: 10, type: 'Creature', status: "Injured", svgStateKey: 'injured' },}; return false; } }
     function calculateNextIdCounter(loadedChars) { let maxId = 0; try { for (const id in loadedChars) { if (id && id.startsWith('combatant')) { const num = parseInt(id.substring(9), 10); if (!isNaN(num) && num >= maxId) { maxId = num + 1; } } } } catch (e) { console.error("Error calculating next ID:", e); return 1;} return Math.max(maxId, 1); }
     function clearSavedData() { console.log("clearSavedData called"); try { if (confirm("ALERT! Clear all saved manifest data?")) { localStorage.removeItem(LOCAL_STORAGE_KEY); window.location.reload(); } } catch (e) { console.error("Error clearing data:", e); alert("Could not clear data."); }}
     function applyTheme(theme) { console.log(`applyTheme called: ${theme}`); try { if (theme === 'dark') { document.body.classList.add('dark-mode'); } else { document.body.classList.remove('dark-mode'); } } catch(e) { console.error("Error applying theme:", e); }}
     function toggleTheme() { console.log("toggleTheme called"); try { let currentTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light'; let newTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem(THEME_STORAGE_KEY, newTheme); applyTheme(newTheme); } catch(e) { console.error("Error toggling theme:", e); }}
     function renderCharacterCard(charId) { try { const character = characters[charId]; const card = document.getElementById(charId); if (!character || !card) return; const statuses = ['healthy', 'injured', 'critical', 'incapacitated', 'dead']; card.className = 'character-card'; statuses.forEach(s => card.classList.remove(`status-${s}`)); if (character.status) { card.classList.add(`status-${character.status.toLowerCase()}`); } const nameDisplay = card.querySelector('.char-name-display'); const nameInput = card.querySelector('.char-name-edit'); if (nameDisplay && nameInput && document.activeElement !== nameInput) { nameDisplay.textContent = (character.name || "NO NAME").toUpperCase(); nameInput.value = character.name || ""; nameDisplay.style.display = 'inline-block'; nameInput.style.display = 'none'; } else if (nameDisplay && nameInput && document.activeElement === nameInput) { nameDisplay.style.display = 'none'; } const statusDisplay = card.querySelector('.status-display'); if(statusDisplay) statusDisplay.textContent = (character.status || "UNKNOWN").toUpperCase(); const monitor = card.querySelector('.health-monitor'); const svgContainer = card.querySelector('.svg-container'); const svgKey = (character.status === 'Dead') ? 'incapacitated' : (character.svgStateKey || 'healthy'); if (monitor && svgContainer && monitor.dataset.currentSvgKey !== svgKey) { requestAnimationFrame(() => { if(document.getElementById(charId)) { svgContainer.innerHTML = svgStates[svgKey] || svgStates['healthy']; monitor.dataset.currentSvgKey = svgKey; setAnimationSpeed(monitor, character); } }); } else if (monitor && svgContainer && svgContainer.innerHTML.trim() === '') { svgContainer.innerHTML = svgStates[svgKey] || svgStates['healthy']; monitor.dataset.currentSvgKey = svgKey; setAnimationSpeed(monitor, character); } else if (monitor) { setAnimationSpeed(monitor, character); } const maxWInput = card.querySelector('.input-wounds-max'); if (maxWInput && document.activeElement !== maxWInput) maxWInput.value = character.woundsMax ?? 1; const curWInput = card.querySelector('.input-wounds-current'); if (curWInput && document.activeElement !== curWInput) curWInput.value = character.woundsCurrent ?? 0; const stressInput = card.querySelector('.input-stress'); const stressIncBtn = card.querySelector(`#inc-stress-${charId}`); const stressDecBtn = card.querySelector(`#dec-stress-${charId}`); const canStress = (character.type !== 'Creature' && character.type !== 'Android'); [stressInput, stressIncBtn, stressDecBtn].forEach(el => { if(el) el.disabled = !canStress; }); if (stressInput && document.activeElement !== stressInput) stressInput.value = canStress ? (character.stress ?? 0) : ''; const bodySInput = card.querySelector('.input-save-body'); if (bodySInput && document.activeElement !== bodySInput) bodySInput.value = character.saveBody ?? ''; const fearSInput = card.querySelector('.input-save-fear'); const fearDis = (character.type === 'Android'); if (fearSInput) { fearSInput.disabled = fearDis; if (document.activeElement !== fearSInput) fearSInput.value = fearDis ? '' : (character.saveFear ?? ''); } const sanSInput = card.querySelector('.input-save-sanity'); const sanDis = (character.type === 'Android'); if (sanSInput) { sanSInput.disabled = sanDis; if (document.activeElement !== sanSInput) sanSInput.value = sanDis ? '' : (character.saveSanity ?? ''); } const apInput = card.querySelector('.input-ap'); if (apInput && document.activeElement !== apInput) apInput.value = character.armorPoints ?? 0; const typeSelect = card.querySelector('.type-select'); if (typeSelect && document.activeElement !== typeSelect) { typeSelect.value = character.type || "NPC"; } const deadBtn = card.querySelector('.mark-dead-btn'); if (deadBtn) { deadBtn.disabled = (character.status === 'Dead'); } } catch (error) { console.error(`Error rendering card ${charId}:`, error); const cardElement = document.getElementById(charId); if (cardElement) cardElement.innerHTML = `<p style='color:red;'>Error render ${charId}.</p>`; } }
     function createCharacterCardElement(charId) { const character = characters[charId]; if (!character) return '<p>Error: Char data missing.</p>'; try { const nameDisplayId = `name-display-${charId}`; const nameInputId = `name-edit-${charId}`; const typeSelectId = `type-${charId}`; const stressDisabled = (character.type === 'Creature' || character.type === 'Android') ? 'disabled' : ''; const fearDisabled = (character.type === 'Android') ? 'disabled' : ''; const sanityDisabled = (character.type === 'Android') ? 'disabled' : ''; const cardHTML = ` <div class="character-card" id="${charId}"> <button class="remove-button" onclick="removeCombatant('${charId}')" title="Remove ${character.name || 'Unit'}">X</button> <div class="health-monitor" data-current-svg-key=""> <div class="svg-container"></div> <div class="monitor-text-overlay"> <div> <span class="char-name-display" id="${nameDisplayId}" onclick="showNameInput('${charId}', '${nameInputId}', '${nameDisplayId}')" title="Click to edit name">${(character.name || "NO NAME").toUpperCase()}</span> <input type="text" class="char-name-edit" id="${nameInputId}" value="${character.name || ""}" onblur="hideNameInput('${charId}', '${nameInputId}', '${nameDisplayId}', true)" onkeydown="if(event.key === 'Enter') { this.blur(); } else if (event.key === 'Escape') { hideNameInput('${charId}', '${nameInputId}', '${nameDisplayId}', false); this.blur(); }" placeholder="ENTER NAME" style="display: none;"> </div> <span class="status-display">${(character.status || "UNKNOWN").toUpperCase()}</span> </div> </div> <div class="card-section wounds-controls"> <div class="wound-adjust"> <label>WOUNDS:</label> <button onclick="updateStatus('${charId}', 'decrementWounds', 1)" title="Decrease Current Wounds">-</button> </div> <div class="wound-inputs"> <div class="wound-input-group"> <label for="curr-wounds-${charId}">CURRENT:</label> <input type="number" id="curr-wounds-${charId}" class="input-wounds-current" value="${character.woundsCurrent ?? 0}" min="0" onchange="updateStatus('${charId}', 'setCurrentWounds', this.value)"> </div> <div class="wound-input-group"> <label for="max-wounds-${charId}">MAX:</label> <input type="number" id="max-wounds-${charId}" class="input-wounds-max" value="${character.woundsMax ?? 1}" min="1" onchange="updateStatus('${charId}', 'setMaxWounds', this.value)"> </div> </div> <div class="wound-adjust"> <button onclick="updateStatus('${charId}', 'incrementWounds', 1)" title="Increase Current Wounds">+</button> </div> </div> <div class="card-section info-grid"> <div class="stat-adjust"> <label for="${typeSelectId}">CLASS/TYPE:</label> <select id="${typeSelectId}" class="type-select" onchange="updateStatus('${charId}', 'setType', this.value)"> <option value="Marine" ${character.type === 'Marine' ? 'selected' : ''}>Marine</option> <option value="Scientist" ${character.type === 'Scientist' ? 'selected' : ''}>Scientist</option> <option value="Teamster" ${character.type === 'Teamster' ? 'selected' : ''}>Teamster</option> <option value="Android" ${character.type === 'Android' ? 'selected' : ''}>Android</option> <option value="NPC" ${character.type === 'NPC' ? 'selected' : ''}>NPC</option> <option value="Creature" ${character.type === 'Creature' ? 'selected' : ''}>Creature</option> </select> </div> <div class="stat-adjust"> <label for="stress-${charId}">STRESS:</label> <div class="value-adjust-wrapper"> <button id="dec-stress-${charId}" onclick="updateStatus('${charId}', 'decrementStress', 1)" ${stressDisabled}>-</button> <input type="number" id="stress-${charId}" class="input-stress" value="${(character.type !== 'Creature' && character.type !== 'Android') ? (character.stress ?? 0) : ''}" min="0" onchange="updateStatus('${charId}', 'setStress', this.value)" ${stressDisabled}> <button id="inc-stress-${charId}" onclick="updateStatus('${charId}', 'incrementStress', 1)" ${stressDisabled}>+</button> </div> </div> </div> <div class="card-section saves-armor-panel"> <div class="save-input-group"> <label for="ap-${charId}">AP:</label> <input type="number" id="ap-${charId}" class="input-ap" value="${character.armorPoints ?? 0}" min="0" max="99" onchange="updateStatus('${charId}', 'setArmorPoints', this.value)"> </div> <div class="save-input-group"> <label for="save-body-${charId}">BODY:</label> <input type="number" id="save-body-${charId}" class="input-save-body" value="${character.saveBody ?? ''}" min="0" max="100" onchange="updateStatus('${charId}', 'setSaveBody', this.value)"> </div> <div class="save-input-group"> <label for="save-fear-${charId}">FEAR:</label> <input type="number" id="save-fear-${charId}" class="input-save-fear" value="${fearDisabled ? '' : (character.saveFear ?? '')}" min="0" max="100" onchange="updateStatus('${charId}', 'setSaveFear', this.value)" ${fearDisabled}> </div> <div class="save-input-group"> <label for="save-sanity-${charId}">SANITY:</label> <input type="number" id="save-sanity-${charId}" class="input-save-sanity" value="${sanityDisabled ? '' : (character.saveSanity ?? '')}" min="0" max="100" onchange="updateStatus('${charId}', 'setSaveSanity', this.value)" ${sanityDisabled}> </div> </div> <div class="card-section action-button-area"> <button class="mark-dead-btn" id="dead-${charId}" onclick="updateStatus('${charId}', 'setDead', true)" title="Mark character as Dead" ${character.status === 'Dead' ? 'disabled' : ''}>Mark Dead</button> </div> </div>`; return cardHTML; } catch (error) { console.error(`Error generating HTML for card ${charId}:`, error); return `<div id="${charId}" class="character-card" style="border-color:red;"><p>Error creating card ${charId}.</p></div>`; } }
     function renderDashboard() { console.log("renderDashboard called"); const dashboardElement = document.getElementById('dashboard'); if (!dashboardElement) { console.error("Dashboard element not found!"); alert("Fatal Error: Dashboard container missing."); return; } const activeElement = document.activeElement; const activeElementId = activeElement ? activeElement.id : null; const activeElementSelectionStart = activeElement ? activeElement.selectionStart : null; const activeElementSelectionEnd = activeElement ? activeElement.selectionEnd : null; const fragment = document.createDocumentFragment(); const sortedCharIds = Object.keys(characters); console.log(`Rendering ${sortedCharIds.length} characters.`); sortedCharIds.forEach(charId => { if (!characters[charId]) { console.warn(`Skipping invalid ID: ${charId}`); return; } const tempDiv = document.createElement('div'); tempDiv.innerHTML = createCharacterCardElement(charId); const cardElement = tempDiv.firstElementChild; if (cardElement && cardElement.classList.contains('character-card')) { fragment.appendChild(cardElement); setTimeout(() => renderCharacterCard(charId), 0); } else { console.error(`Failed to create valid card element for ${charId}`); if(cardElement) fragment.appendChild(cardElement); } }); dashboardElement.innerHTML = ''; dashboardElement.appendChild(fragment); if (activeElementId) { const el = document.getElementById(activeElementId); if (el) { el.focus(); if (activeElementSelectionStart !== null && typeof el.setSelectionRange === 'function') { try { el.setSelectionRange(activeElementSelectionStart, activeElementSelectionEnd); } catch (e) {} } } } console.log("renderDashboard finished"); }
     function updateStatus(charId, action, value) { try { const character = characters[charId]; if (!character) return; const allowedIfDead = ['setName', 'setMaxWounds', 'setType', 'setSaveBody', 'setSaveFear', 'setSaveSanity', 'setArmorPoints']; if (character.status === 'Dead' && !allowedIfDead.includes(action)) { console.log(`${character.name} is Dead. Action blocked: ${action}`); return; } let needsFullRender = false; const previousStatus = character.status; switch (action) { case 'setName': if(typeof value === 'string') { character.name = value.trim() || "UNNAMED"; } break; case 'setType': const vTypes=['Marine','Scientist','Teamster','Android','NPC','Creature']; if(vTypes.includes(value)){const oldT=character.type;character.type=value;if(value==='Android'||value==='Creature')character.stress=null;else if(oldT==='Android'||oldT==='Creature')character.stress=character.stress??0;if(value==='Android'){character.saveFear=null;character.saveSanity=null;}else if(oldT==='Android'){character.saveFear=character.saveFear??30;character.saveSanity=character.saveSanity??30;}needsFullRender=true;} break; case 'setMaxWounds': const nMaxW=parseInt(value,10); if(!isNaN(nMaxW)&&nMaxW>=1){character.woundsMax=nMaxW;if(character.status!=='Dead')character.woundsCurrent=Math.min(character.woundsCurrent??0,character.woundsMax);}else{const iEl=document.getElementById(`max-wounds-${charId}`);if(iEl)iEl.value=character.woundsMax;} break; case 'setCurrentWounds': const nCurW=parseInt(value,10); if(!isNaN(nCurW)){if(character.status==='Dead')break;character.woundsCurrent=Math.max(0,Math.min(nCurW,character.woundsMax??0));}else{const iEl=document.getElementById(`curr-wounds-${charId}`);if(iEl)iEl.value=character.woundsCurrent;} break; case 'incrementWounds': if(character.status!=='Dead'&&character.status!=='Incapacitated')character.woundsCurrent=Math.min(character.woundsMax??0,(character.woundsCurrent??0)+1); else if(character.status==='Incapacitated') character.woundsCurrent=1; break; case 'decrementWounds': if(character.status!=='Dead')character.woundsCurrent=Math.max(0,(character.woundsCurrent??0)-1); break; case 'setStress': const nStr=parseInt(value,10); if(character.type!=='Creature'&&character.type!=='Android'&&!isNaN(nStr)){character.stress=Math.max(0,nStr);}else if(character.type!=='Creature'&&character.type!=='Android'){const iEl=document.getElementById(`stress-${charId}`);if(iEl)iEl.value=character.stress;} break; case 'incrementStress': if(character.type!=='Creature'&&character.type!=='Android'&&character.stress!==null){character.stress=(character.stress??0)+1;} break; case 'decrementStress': if(character.type!=='Creature'&&character.type!=='Android'&&character.stress!==null){character.stress=Math.max(0,(character.stress??0)-1);} break; case 'setSaveBody': const nBody=parseInt(value,10); if(!isNaN(nBody)&&nBody>=0&&nBody<=100)character.saveBody=nBody;else{const iEl=document.getElementById(`save-body-${charId}`);if(iEl)iEl.value=character.saveBody;} break; case 'setSaveFear': const nFear=parseInt(value,10); if(character.type!=='Android'&&!isNaN(nFear)&&nFear>=0&&nFear<=100)character.saveFear=nFear;else if(character.type!=='Android'){const iEl=document.getElementById(`save-fear-${charId}`);if(iEl)iEl.value=character.saveFear;} break; case 'setSaveSanity': const nSan=parseInt(value,10); if(character.type!=='Android'&&!isNaN(nSan)&&nSan>=0&&nSan<=100)character.saveSanity=nSan;else if(character.type!=='Android'){const iEl=document.getElementById(`save-sanity-${charId}`);if(iEl)iEl.value=character.saveSanity;} break; case 'setArmorPoints': const nAP=parseInt(value,10); if(!isNaN(nAP)&&nAP>=0&&nAP<=99)character.armorPoints=nAP;else{const iEl=document.getElementById(`ap-${charId}`);if(iEl)iEl.value=character.armorPoints;} break; case 'setDead': if (character.status !== 'Dead') { character.status = 'Dead'; character.woundsCurrent = 0; character.svgStateKey = 'incapacitated'; console.log(`${character.name} marked as DEAD by Warden.`); needsFullRender = true; } break; }
            if (action !== 'setDead' && character.status !== 'Dead') { const currentW = character.woundsCurrent ?? 0; const maxW = character.woundsMax ?? 1; let newStatus = "Healthy"; let newSvgKey = "healthy"; if (currentW <= 0) { newStatus = "Incapacitated"; newSvgKey = "incapacitated"; if (previousStatus !== "Incapacitated" && previousStatus !== "Dead") console.log(`${character.name} is Incapacitated (0 Wounds).`); } else if (currentW === 1 && maxW > 1) { newStatus = "Critical"; newSvgKey = "critical"; } else if (currentW < maxW) { newStatus = "Injured"; newSvgKey = "injured"; } if (character.status !== newStatus) character.status = newStatus; if (character.svgStateKey !== newSvgKey) character.svgStateKey = newSvgKey; } else if (character.status === 'Dead') { character.woundsCurrent = 0; character.svgStateKey = 'incapacitated'; }
            saveStateToLocalStorage();
            if (needsFullRender || previousStatus !== character.status) { renderDashboard(); } else { renderCharacterCard(charId); } } catch (error) { console.error(`Error in updateStatus for ${charId} (${action}):`, error); alert(`Error updating ${charId}. Check console.`); } }
    // --- Initial Load & Render ---
    document.addEventListener('DOMContentLoaded', () => { console.log("DOMContentLoaded event fired"); try { const savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light'; applyTheme(savedTheme); if (!loadStateFromLocalStorage()) { nextCombatantIdCounter = calculateNextIdCounter(characters); } else { nextCombatantIdCounter = calculateNextIdCounter(characters); } renderDashboard(); } catch (error) { console.error("FATAL ERROR during initial page load:", error); alert("Critical error loading tracker. Check console (F12)."); const d = document.getElementById('dashboard'); if (d) { d.innerHTML = `<p style='color:red; text-align: center;'>INIT FAILED. Check Console (F12).</p>`; } } });

</script>

</body>
</html>
